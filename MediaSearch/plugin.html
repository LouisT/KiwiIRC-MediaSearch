<script>
/*
  Kiwi IRC Media Search - By Louis T. < https://ltdev.im/ >

  [Required API Keys]
  500px:        https://500px.com/settings/applications
  Giphy:        https://github.com/Giphy/GiphyAPI
  Imgur:        https://api.imgur.com/
  Instagram:    https://www.instagram.com/developer/
  Last.fm:      http://www.last.fm/api
  SoundCloud:   http://soundcloud.com/you/apps
  Vimeo:        https://developer.vimeo.com/apps
  YouTube:      https://developers.google.com/youtube/v3/getting-started
*/
var MediaSearch = {
    // API settings, object key is the 'MediaSearch' font value.
    // NOTE: Any service listed above requires an API key.
    apis: {
       '500px': {
           // Search by default?
           status: false,
           // Service name.
           name: '500px',
           // API key is required.
           apikey: '',
           // Usable search provider? (false without API key)
           enabled: false
       },
       coub: {
           status: false,
           name: 'Coub',
           enabled: true,
           /*
              This is the display toggle. Any API that requires a CORS proxy needs this. 
              Do not remove or change this variable, it can break things.
           */
           proxied: true
       },
       giphy: {
           status: false,
           name: 'Giphy',
           apikey: 'dc6zaTOxFJmzC',
           enabled: true
       },
       gfycat: {
           status: false,
           name: 'Gfycat',
           enabled: true
       },
       imgur: {
           status: false,
           name: 'Imgur',
           apikey: 'ec08fb234c609fb',
           enabled: true
       },
       instagram: {
           status: false,
           name: 'Instagram',
           apikey: '',
           enabled: false
       },
       lastfm: {
           status: false,
           name: 'Last.fm',
           apikey: '',
           enabled: false
       },
       mixcloud: {
           status: false,
           name: 'Mixcloud',
           enabled: true
       },
       soundcloud: {
           status: false,
           name: 'SoundCloud',
           apikey: '',
           enabled: false
       },
       spotify: {
           status: true,
           name: 'Spotify',
           enabled: true
       },
       'stack-overflow': {
           status: false,
           name: 'Stack Overflow',
           enabled: true
       },
       twitch: {
           status: false,
           name: 'Twitch',
           enabled: true
       },
       vimeo: {
           status: true,
           name: 'Vimeo',
           apikey: '',
           enabled: false
       },
       youtube: {
           status: true,
           name: 'YouTube',
           apikey: '',
           enabled: false
       }
    },

    // Autocomplete in the search input.
    autocomplete: {
        // Use auto complete from Bing?
        enabled: true,
        // How fast to update the suggestions.
        speed: 500,
    },

    // Number of results to display; Calculated default: ~~(max - (max - min) / 2)
    limit: {
        min: 5,
        max: 50,
    },

    // Required 3rd party libraries.
    libraries: [
        'https://apis.google.com/js/client.js',
        'https://platform.instagram.com/en_US/embeds.js'
    ],

    // A 1px image placeholder.
    placeholder: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',

    /*
      Some providers (Looking at you, Coub!) do not provide CORS or a callback.
      This is the best way to support a provider at this time. If you wish to disable
      the use of proxies, just set cors.enabled to false. Please be aware, NO content
      besides the provider links are sent to any of the proxies. The more proxies the less
      chance for failure!
    */
    corsproxy: {
        enabled: true,
        proxies: [
            'https://jsonp.afeld.me/?url={{:URL}}',
            'https://crossorigin.me/{{:URL}}',
            'https://cors.5apps.com/?uri={{:URL}}',
            'https://cors-anywhere.herokuapp.com/{{:URL}}',
            'https://allow-any-origin.appspot.com/{{:URL}}',

            // [<proxy url>, <content filter function>],
            ['https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20json%20where%20url%3D%22{{:URL_ENC}}%22&format=json', function (data) {
                return (((data.query||{}).results||{}).json);
            }],
            ['https://anyorigin.com/get/?url={{:URL_ENC}}&callback=?', function (data) {
                return (data.contents||{});
            }],
        ],
    }
}
</script>
<style>
    #kiwi .ms-wrapper {
        color: white;
        position: absolute;
        background: #3c3b37;
        padding: 5px;
        width: 35%;
        height: 45%;
        min-width: 383px;
        min-height: 300px;
        overflow: hidden;
        border-top-left-radius: 8px;
        max-width: 509px;
        z-index: 100;
    }
    #kiwi .ms-wrapper .close {
        float: right;
    }
    #kiwi .ms-wrapper .menu {
        cursor: pointer;
        padding: 5px;
    }
    #kiwi .ms-wrapper .menu:hover {
        color: #88C56A;
    }
    #kiwi .ms-wrapper .ms-main {
        width: 50%;
    }
    #kiwi .ms-wrapper .list .ms-start-label {
        position: absolute;
        width: 50%;
        left: 25%;
        top: 25%;
        height: 10%;
        font-size: 20px;
    }
    #kiwi .ms-wrapper .list .ms-start {
        position: absolute;
        width: 50%;
        left: 25%;
        top: 50%;
        height: 10%;
        transform: translateX(-25%);
        -webkit-transform: translateX(-25%);
        transform: translateY(-50%);
        -webkit-transform: translateY(-50%);
    }
    #kiwi .ms-wrapper hr {
        margin: 5px;
    }
    #kiwi .ms-wrapper .break {
        margin: 0;
        margin-top: 5px;
        margin-bottom: 5px;
        color: black;
    }
    #kiwi .ms-wrapper .list {
        padding-bottom: 5px;
        overflow-y: scroll;
        z-index: -5;
        height: 88%;
        overflow-x: hidden;
    }
    #kiwi .ms-wrapper .list .thumbnail {
        width: 120px;
        height: 90px;
        position: relative;
        margin-right: 5px;
        margin-bottom: 5px;
        cursor: pointer;
    }
    #kiwi .ms-wrapper .list .thumbnail img {
        background-color: #949993;
        width: 120px;
        height: 90px;
    }
    #kiwi .ms-wrapper .list .thumbnail .icon {
        position: absolute;
        bottom: 0;
        left: 0;
        margin-bottom: 3px;
        color: #88C56A;
        background-color: rgba(0,0,0,0.7);
        width: auto;
        padding: 5px;
        pointer-events: none;
    }
    #kiwi .ms-wrapper .list .toggle {
        margin: 5px !important;
    }
    #kiwi .ms-wrapper .list .toggle:hover {
        cursor: pointer;
    }
    #kiwi .ms-wrapper .list .share {
        float: right;
        display: inline-block;
        padding-right: 5px;
    }
    #kiwi .ms-wrapper .list h4 {
        margin-bottom: 0px;
        font-size: 18px;
        width: 50%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
    }
    #kiwi .ms-wrapper .date {
        font-size: 10px;
        float: right;
        margin-right: 10px;
    }
    #kiwi .ms-wrapper .list div {
        width: 100%;
        display: inline-block;
    }
    #kiwi .ms-wrapper .list .gif:before {
        position: absolute;
        content: 'GIF';
        font-size: 20px;
        bottom: 0;
        right: 0;
        padding: 5px;
        pointer-events: none;
    }
    #kiwi .ms-wrapper .list .ms-providers {
        width: 85%;
    }
    #kiwi .ms-wrapper .list h6 {
        margin-bottom: 0px;
    }
    #kiwi .ms-wrapper .list #ms-limit {
        background: transparent none repeat scroll 0% 0%;
        color: rgb(148, 153, 147);
        -webkit-box-shadow: none;
        box-shadow: none;
        font-size: 20px;
        width: 10%;
        padding-top: 0px;
    }
    #kiwi .ms-wrapper .list .tooltip:hover:after {
        font-size: 16px;
        border: 1px solid;
        padding: 6px;
        margin-bottom: 0px;
        background: #000;
        background: rgba(0,0,0,.85);
        content: attr(data-title);
        position: fixed;
        bottom: 0;
        right: 0;
        z-index: 1000;
     }
</style>
<script>
(function (global, $MS, undefined) {
    // Load required 3rd party libraries.
    $.each($MS.libraries, function (idx, link) {
       $.getScript(link);
    });

    // XXX: Load the MediaSearch font; There must be a better way!?
    $.each(_.keys(kiwi.plugins.loaded_plugins), function (idx, str) {
        if (str.match(/mediasearch\/plugin\.html$/i)) {
           $('head').append(['<link rel="stylesheet" type="text/css" href="', str.replace(/plugin\.html$/i,'ms-font/MediaSearch.css'), '"/>'].join(''));
        }
    });

    var mediabox = $($('#tmpl_mediasearch').html()).hide().appendTo($('#kiwi')),
        control = kiwi.components.ControlInput(),
        area =  $('#kiwi .controlbox textarea'),
        msstart = '<center><h5 class="ms-start-label">Search...</h5></center><input class="ms-start"/>';
    $MS.__requests = [];
    $MS.__autocompletes = [];
    $MS.limit.current = ~~($MS.limit.max - ($MS.limit.max - $MS.limit.min) / 2);
    $('.ms-wrapper .list').html(msstart);
    control.addPluginIcon($('<a title="Media Search"><i class="fa fa-search"></i></a>').click(function () {
        mediabox.show().css({bottom: ($('.controlbox').outerHeight())+'px', right: 0});
        $('.ms-wrapper .list .ms-start').focus();
    }));
    if ($MS.apis.youtube.status) {
       $MS.apis.youtube.status = false;
       $MS.apis.youtube.__trigger = true;
    }
    (function hasGapi (gapiCounter) {
        if (gapiCounter++ >= 100) {
           console.log('Failed to load gapi! "YTS" plugin nonfunctional.');
         } else if (global['gapi'] && global['gapi'].client) {
           global['gapi'].client.setApiKey($MS.apis.youtube.apikey);
           global['gapi'].client.load('youtube', 'v3', function () {
               if ($MS.apis.youtube.__trigger) {
                  $MS.apis.youtube.status = true;
                  $('.ms-wrapper .list .toggle.ms-youtube').css('color','#88C56A');
               }
           });
        } else { setTimeout(function () { hasGapi(gapiCounter); }, 200); };
    })(0);
    $(global).resize(function () {
        mediabox.hide();
    });
    $('.ms-wrapper .undo').click(function () {
        cleanMediaSearch();
        $('.ms-wrapper .ms-main').val('');
        $('.ms-wrapper .list').html(msstart);
        bindSearchInputs($MS);
    });
    $('.ms-wrapper .close').click(function () {
        mediabox.hide();
        $('.ms-wrapper .undo').click();
    });
    $.each(_.keys($MS.apis), function (idx, key) {
        if (!$MS.apis[key].enabled) {
           $MS.apis[key].status = false;
        }
        if ($MS.apis[key].proxied && !$MS.corsproxy.enabled) {
           $MS.apis[key].enabled = $MS.apis[key].status = false;
        }
    });
    bindSearchInputs($MS);
    $('.ms-wrapper .settings').click(function () {
        cleanMediaSearch();
        $('.ms-wrapper .list').html([
            '<center><h4>Search Providers</h4><br /><div class="ms-providers"></div><br />',
            '<h6>Search Limit:</h6><input type="number" id="ms-limit" min="', $MS.limit.min,
            '" max="', $MS.limit.max, '" step="1" value="', $MS.limit.current, '"></center>'
        ].join(''));
        $('#ms-limit').bind('click keyup', function (e) {
            var elm = $(this),
                val = elm.val(),
                min = $MS.limit.min,
                max = $MS.limit.max;
            if ($MS._timer) {
               clearTimeout($MS._timer);
            }
            if (e.keyCode && e.keyCode !== 8 && val.length === 0) {
               $MS.limit.current = ~~(max - (max-min)/2);
               return elm.val($MS.limit.current);
            }
            $MS._timer = setTimeout(function () {
               if (!elm.val() || elm.val() === val) {
                  $MS.limit.current = Number(val>max?max:(val<min?min:val));
                  elm.val($MS.limit.current);
               }
            }, (val?500:5000));
        });
        $.each(_.keys($MS.apis), function (index, key) {
            var obj = $MS.apis[key];
            if (obj.enabled) {
               var elm = $('<i class="tooltip toggle ms ms-'+key+' ms-3x" data-title="'+obj.name+'"></i>');
               elm.click(function () {
                   obj.status = !obj.status;
                   $(this).css('color',(obj.status?'#88C56A':'#949993'));
               }).css('color',(obj.status?'#88C56A':'#949993'));
               $('.ms-providers').append(elm);
            }
        });
    });
    $('.ms-wrapper .search').click(function () {
        var val;
        if (!(val = $('.ms-wrapper .ms-start').val())) {
           val = $('.ms-wrapper .ms-main').val();
         } else {
           $('.ms-wrapper .ms-main').val(val);
        }
        $('.ms-wrapper .list').empty();
        cleanMediaSearch();
        var failed;
        if (!_.some(_.keys($MS.apis), function (key) { return $MS.apis[key].status; })) {
           failed = 'Please enable a search provider in options.';
         } else if ((!val || 0 === val.length || /^\s*$/.test(val))) {
           failed = 'Search must not be empty.';
        }
        if (failed) {
           $('.ms-wrapper .list').html(msstart);
           $('.ms-wrapper .list .ms-start-label').text(failed);
           return bindSearchInputs($MS);
        }

        // 500px
        if ($MS.apis['500px'].status) {
           $MS.__requests.push($.ajax({
               url: ['https://api.500px.com/v1/photos/search?term=', encodeURIComponent(val), '&consumer_key=', $MS.apis['500px'].apikey,
                     '&rpp=', $MS.limit.current].join(''),
               dataType: 'json',
            }).done(function (json) {
               if (json.photos && json.photos.length >= 1) {
                  var html = [];
                  $.each(json.photos, function (index, item) {
                      if (item.url) {
                         var link = ['https://500px.com',item.url].join(''),
                             img = (item.image_url||$MS.placeholder);
                         html.push([
                             '<span class="thumbnail 500px tooltip" data-title="', $('<div />').html(item.description||'N/A').text(), '" data-link="', link,
                             '"><img src="', img, '" /><div class="icon"><i class="ms ms-500px ms-2x"></i></div></span>'
                         ].join(''));
                      }
                  });
                  displayResults('500px', html);
                } else {
                  onFailure($MS.apis['500px'].name)();
               }
           }).fail(onFailure($MS.apis['500px'].name)));
        }

        // Coub
        if ($MS.apis['coub'].status && $MS.corsproxy.enabled) {
           var proxies = getProxyProviders(),
               endpoint = ['https://coub.com/api/v2/search?q=', encodeURIComponent(val), '&order_by=newest_popular'].join('');
           (function coubRequest (pid, proxy, filter) {
               if ((proxy = proxies[pid])) {
                  if (Array.isArray(proxy)) {
                     filter = proxy[1];
                     proxy = proxy[0];
                  }
                  var req = formatter(proxy, { URL: endpoint, URL_ENC: encodeURIComponent(endpoint) });
               }
               if (req) {
                  $MS.__requests.push($.ajax({
                      url: req,
                      dataType: 'json',
                   }).done(function (json) {
                      if (filter) {
                         json = filter(json);
                      }
                      if (json.coubs && json.coubs.length >= 1) {
                         var html = [];
                         $.each(json.coubs, function (index, item) {
                             if (item.permalink) {
                                var link = ['https://coub.com/view/', item.permalink].join(''),
                                    img = (item.small_picture||$MS.placeholder);
                                html.push([
                                    '<span class="thumbnail coub tooltip" data-title="', $('<div />').html(item.title||'N/A').text(), '" data-link="', link,
                                    '"><img src="', img, '" /><div class="icon"><i class="ms ms-coub ms-2x"></i></div></span>'
                                ].join(''));
                             }
                         });
                         displayResults('coub', html);
                       } else {
                         onFailure($MS.apis['coub'].name)();
                      }
                   }).fail(function () {
                      return (proxies[pid+1]?coubRequest:onFailure($MS.apis['coub'].name))(++pid);
                  }));
                } else {
                  onFailure($MS.apis['coub'].name)();
               }
           })(0);
        }

        // Giphy
        if ($MS.apis['giphy'].status) {
           $MS.__requests.push($.ajax({
               url: ['http://api.giphy.com/v1/gifs/search?q=', encodeURIComponent(val), '&api_key=', $MS.apis['giphy'].apikey,
                     '&limit=', $MS.limit.current, '&rating=r'].join(''),
               dataType: 'json',
            }).done(function (json) {
               if (json.data && json.data.length >= 1) {
                  var html = [];
                  $.each(json.data, function (index, item) {
                      if (item.url) {
                         var title = $('<div />').html([(item.slug||'N/A'), ' - Rated: ', (item.rating||'N/A')].join('')).text(),
                             imgs = { still: item.images.original_still.url, hover: item.images.original.url };
                         html.push([
                             '<span class="thumbnail giphy gif tooltip" data-title="', title, '" data-link="', item.url,
                             '"><img src="', imgs.still, '" data-still="', imgs.still, '" data-hover="', imgs.hover,
                             '" /><div class="icon"><i class="', 'ms ms-giphy ms-2x"></i></div></span>'
                         ].join(''));
                      }
                  });
                  displayResults('giphy', html);
                  $('.giphy img').hover(function () {
                      $(this).attr('src', $(this).attr('data-hover'));
                   }, function () {
                      $(this).attr('src', $(this).attr('data-still'));
                  });
                } else {
                  onFailure($MS.apis['giphy'].name)();
               }
           }).fail(onFailure($MS.apis['giphy'].name)));
        }

        // Gfycat
        if ($MS.apis['gfycat'].status) {
           $MS.__requests.push($.ajax({
               url: ['https://api.gfycat.com/v1/gfycats/search?search_text=', encodeURIComponent(val),
                     '&count=', $MS.limit.current].join(''),
               dataType: 'json',
            }).done(function (json) {
               if (json.gfycats && json.gfycats.length >= 1) {
                  var html = [];
                  $.each(json.gfycats, function (index, item) {
                      if (item.gfyName) {
                         var title = $('<div />').html([(item.title||'N/A'), ' - NSFW: ', (item.nsfw?'yes':'no')].join('')).text(),
                             imgs = { still: item.posterUrl, hover: item.gifUrl },
                             link = ['https://gfycat.com/', item.gfyName].join('');
                         html.push([
                             '<span class="thumbnail gfycat gif tooltip" data-title="', title, '" data-link="', link,
                             '"><img src="', imgs.still, '" data-still="', imgs.still, '" data-hover="', imgs.hover,
                             '" /><div class="icon"><i class="', 'ms ms-gfycat ms-2x"></i></div></span>'
                         ].join(''));
                      }
                  });
                  displayResults('gfycat', html);
                  $('.gfycat img').hover(function () {
                      $(this).attr('src', $(this).attr('data-hover'));
                   }, function () {
                      $(this).attr('src', $(this).attr('data-still'));
                  });
                } else {
                  onFailure($MS.apis['gfycat'].name)();
               }
           }).fail(onFailure($MS.apis['gfycat'].name)));
        }

        // Imgur
        if ($MS.apis.imgur.status) {
           $MS.__requests.push($.ajax({
               url: ['https://api.imgur.com/3/gallery/search/time/1?q=', encodeURIComponent(val)].join(''),
               dataType: 'json',
               headers: {
                   'Authorization': ['Client-ID ', $MS.apis['imgur'].apikey].join(''),
               },
            }).done(function (json) {
               if (json.data && json.data.length >= 1) {
                  var html = [];
                  json.data = json.data.filter(function (obj) {
                      return !obj.is_album;
                  });
                  $.each(json.data.slice(0, $MS.limit.current), function (index, item) {
                      if (item.link) {
                         var isgif = (item.type && item.type == 'image/gif'),
                             img = (isgif?$MS.placeholder:item.link);
                         html.push([
                             '<span class="thumbnail imgur', (isgif?' gif':''), ' tooltip" data-title="', item.title, ' - ',
                             (item.account_url||'N/A'), '" data-link="', item.link, '"><img src="', img, '" data-still="', $MS.placeholder,
                             '" data-hover="', item.link, '" /><div class="icon">', '<i class="ms ms-imgur ms-2x"></i></div></span>'
                         ].join(''));
                      }
                  });
                  displayResults('imgur', html);
                  $('.imgur.gif img').hover(function () {
                      $(this).attr('src', $(this).attr('data-hover'));
                   }, function () {
                      $(this).attr('src', $(this).attr('data-still'));
                  });
                } else {
                  onFailure($MS.apis['imgur'].name)();
               }
           }).fail(onFailure($MS.apis['imgur'].name)));
        }

        // Instagram
        if ($MS.apis.instagram.status) {
           $MS.__requests.push($.ajax({
               url: ['https://api.instagram.com/v1/tags/', val.replace(/[^a-z0-9]+/gi,''), '/media/recent?count=',
                     $MS.limit.current, '&access_token=', $MS.apis.instagram.apikey, '&callback=?'].join(''),
               dataType: 'jsonp',
            }).done(function (json) {
               if (json.data && json.data.length >= 1) {
                  var html = [];
                  $.each(json.data, function (index, item) {
                      if (item.link) {
                         var img = (item.images && item.images.thumbnail.url?item.images.thumbnail.url:$MS.placeholder);
                         html.push([
                             '<span class="thumbnail instagram tooltip" data-title="', (item.caption.text||'N/A'), '" data-link="', item.link,
                             '"><img src="', img, '" /><div class="icon"><i class="ms ms-instagram ms-2x"></i></div></span>'
                         ].join(''));
                      }
                  });
                  displayResults('instagram', html);
                } else {
                  onFailure($MS.apis['instagram'].name)();
               }
           }).fail(onFailure($MS.apis['instagram'].name)));
        }

        // Last.fm
        if ($MS.apis.lastfm.status) {
           $MS.__requests.push($.ajax({
               url: ['https://ws.audioscrobbler.com/2.0/?method=track.search&track=', encodeURIComponent(val), '&api_key=', $MS.apis.lastfm.apikey,
                     '&limit=', $MS.limit.current, '&format=json'].join(''),
               dataType: 'json',
            }).done(function (json) {
               if (json.results && json.results.trackmatches && json.results.trackmatches.track && json.results.trackmatches.track.length >= 1) {
                  var html = [];
                  $.each(json.results.trackmatches.track, function (index, item) {
                      if (item.url) {
                         var img = $MS.placeholder,
                             arr = item.image.reverse();
                         for (var idx in arr) {
                             if (!(!arr[idx]['#text'] || 0 === arr[idx]['#text'].length)) {
                                img = arr[idx]['#text'];
                                break;
                             }
                         }
                         html.push([
                             '<span class="thumbnail lastfm tooltip" data-title="', item.name, ' - ', item.artist, '" data-link="', item.url,
                             '"><img src="', img, '" /><div class="icon"><i class="ms ms-lastfm ms-2x"></i></div></span>'
                         ].join(''));
                      }
                  });
                  displayResults('lastfm', html);
                } else {
                  onFailure($MS.apis['lastfm'].name)();
               }
           }).fail(onFailure($MS.apis['lastfm'].name)));
        }

        // Mixcloud
        if ($MS.apis.mixcloud.status) {
           $MS.__requests.push($.ajax({
               url: ['https://api.mixcloud.com/search/?q=', encodeURIComponent(val), '&type=cloudcast&limit=', $MS.limit.current].join(''),
               dataType: 'json',
            }).done(function (json) {
               if (json.data && json.data.length >= 1) {
                  var html = [];
                  $.each(json.data, function (index, item) {
                      if (item.url) {
                         var img = item.pictures[(item.pictures.medium?'medium':'large')]||$MS.placeholder;
                         html.push([
                             '<span class="thumbnail mixcloud tooltip" data-title="', item.name, '" data-link="', item.url,
                             '"><img src="', img, '" /><div class="icon"><i class="ms ms-mixcloud ms-2x"></i></div></span>'
                         ].join(''));
                      }
                  });
                  displayResults('mixcloud', html);
                } else {
                  onFailure($MS.apis['mixcloud'].name)();
               }
           }).fail(onFailure($MS.apis['mixcloud'].name)));
        }

        // SoundCloud
        if ($MS.apis.soundcloud.status) {
           $MS.__requests.push($.ajax({
               url: ['https://api.soundcloud.com/tracks.json?q=', encodeURIComponent(val), '&limit=', $MS.limit.current,
                     '&client_id=', $MS.apis.soundcloud.apikey].join(''),
               dataType: 'json',
            }).done(function (json) {
               if (json && json.length >= 1) {
                  var html = [];
                  $.each(json, function (index, item) {
                      if (item.permalink_url) {
                         var img = item[(item.artwork_url?'artwork_url':'waveform_url')]||null;
                         html.push([
                             '<span class="thumbnail soundcloud tooltip" data-title="', item.title, '" data-link="', item.permalink_url,
                             '"><img src="', img, '" /><div class="icon"><i class="ms ms-soundcloud ms-2x"></i></div></span>'
                         ].join(''));
                      }
                  });
                  displayResults('soundcoud', html);
                } else {
                  onFailure($MS.apis['soundcloud'].name)();
               }
           }).fail(onFailure($MS.apis['soundcloud'].name)));
        }

        // Spotify
        if ($MS.apis.spotify.status) {
           $MS.__requests.push($.ajax({
               url: ['https://api.spotify.com/v1/search?q=', encodeURIComponent(val), '&type=track&limit=', $MS.limit.current].join(''),
               dataType: 'json',
            }).done(function (json) {
               if (json.tracks && json.tracks.items.length >= 1) {
                  var html = [];
                  $.each(json.tracks.items, function (index, item) {
                      if (item.external_urls.spotify && (item.album.images && item.album.images.length >= 1)) {
                         var title = (item.artists?item.artists[0].name+' - ':'')+(item.name?item.name:'...'),
                             img = item.album.images.sort(function(a, b) {
                                 return a.width - b.width;
                             })[0].url||$MS.placeholder;
                         html.push([
                             '<span class="thumbnail spotify tooltip" data-title="', title, '" data-link="',
                             item.external_urls.spotify, '"><img src="', img, '" />',
                             '<div class="icon"><i class="ms ms-spotify ms-2x"></i></div></span>'
                         ].join(''));
                      }
                  });
                  displayResults('spotify', html);
                } else {
                  onFailure($MS.apis['spotify'].name)();
               }
           }).fail(onFailure($MS.apis['spotify'].name)));
        }

        // Stack Overflow
        if ($MS.apis['stack-overflow'].status) {
           $MS.__requests.push($.ajax({
               url: ['https://api.stackexchange.com/2.2/search?order=desc&sort=activity&intitle=',
                     encodeURIComponent(val), '&site=stackoverflow&pagesize=', $MS.limit.current].join(''),
               dataType: 'json',
            }).done(function (json) {
               if (json.items && json.items.length >= 1) {
                  var html = [];
                  $.each(json.items, function (index, item) {
                      if (item.link) {
                         var title = [
                                 item.owner.display_name, ' asked: ', item.title, ' (', (item.is_answered?'answered '+item.answer_count+' times':'unanswered'), ')'
                             ].join(''),
                             link = (item.accepted_answer_id?'https://stackoverflow.com/a/'+item.accepted_answer_id:item.link),
                             img = (item.owner.profile_image||$MS.placeholder);
                         html.push([
                             '<span class="thumbnail stack-overflow tooltip" data-title="', title, '" data-link="', link, '"><img src="',
                             img, '" /><div class="icon"><i class="ms ms-stack-overflow ms-2x"></i></div></span>'
                         ].join(''));
                      }
                  });
                  displayResults('stack-overflow', html);
                } else {
                  onFailure($MS.apis['stack-overflow'].name)();
               }
           }).fail(onFailure($MS.apis['stack-overflow'].name)));
        }

        // Twitch
        if ($MS.apis.twitch.status) {
           $MS.__requests.push($.ajax({
               url: ['https://api.twitch.tv/kraken/search/channels?q=', encodeURIComponent(val), '&limit=', $MS.limit.current].join(''),
               dataType: 'json',
            }).done(function (json) {
               if (json.channels && json.channels.length >= 1) {
                  var html = [];
                  $.each(json.channels, function (index, item) {
                      if (item.url) {
                         var title = item.display_name+' playing '+(item.game||'...'),
                             img = item[(item.video_banner?'video_banner':'logo')]||$MS.placeholder;
                         html.push([
                             '<span class="thumbnail twitch tooltip" data-title="', title, '" data-link="', item.url,
                             '"><img src="', img, '" /><div class="icon"><i class="ms ms-twitch ms-2x"></i></div></span>'
                         ].join(''));
                      }
                  });
                  displayResults('twitch', html);
                } else {
                  onFailure($MS.apis['twitch'].name)();
               }
           }).fail(onFailure($MS.apis['twitch'].name)));
        }

        // Vimeo
        if ($MS.apis.vimeo.status) {
           $MS.__requests.push($.ajax({
               url: ['https://api.vimeo.com/videos?query=', encodeURIComponent(val), '&per_page=', $MS.limit.current,
                     '&access_token=', $MS.apis.vimeo.apikey].join(''),
               dataType: 'json',
            }).done(function (json) {
               if (json.data && json.data.length >= 1) {
                  var html = [];
                  $.each(json.data, function (index, item) {
                      if (item.link) {
                         var img = item.pictures.sizes.sort(function(a, b) {
                                 return a.width - b.width;
                             })[0].link||$MS.placeholder;
                         html.push([
                             '<span class="thumbnail vimeo tooltip" data-title="', item.name, '" data-link="', item.link, '"><img src="',
                             img, '" /><div class="icon"><i class="ms ms-vimeo ms-2x"></i></div></span>'
                         ].join(''));
                      }
                  });
                  displayResults('vimeo', html);
                } else {
                  onFailure($MS.apis['vimeo'].name)();
               }
           }).fail(onFailure($MS.apis['vimeo'].name)));
        }

        // YouTube
        if ($MS.apis.youtube.status) {
           var req = global['gapi'].client.youtube.search.list({
               part: 'snippet',
               type: 'video',
               q: val,
               maxResults: $MS.limit.current,
               order: 'viewCount'
           });
           /*
              The GAPI client does not have an abort funtion for some reason!?
              This 'fake' one seems to work; Need to have more people try this
              plugin to find out.
           */
           req.abort = (function (req) {
               return function () {
                   req.__callback = req.__ABORT = $.noop;
               }
           })(req);
           $MS.__requests.push(req);
           req.__callback = function (res) {
               if (res.error || res.items.length <= 0) {
                  onFailure($MS.apis['youtube'].name)();
                } else {
                  var html = [];
                  $.each(res.result.items, function (index, item) {
                      var title = item.snippet.title,
                          vid = item.id.videoId;
                      html.push([
                          '<span class="thumbnail youtube tooltip" data-title="', title, '" data-link="https://youtu.be/',
                          vid, '"><img src="https://i.ytimg.com/vi/', vid, '/default.jpg" /><div class="icon"><i class="ms ',
                          'ms-youtube ms-2x"></i></div></span>'
                      ].join(''));
                  });
                  if (!req.__ABORT) {
                     displayResults('youtube', html);
                  }
               }
           };
           req.execute(function () { req.__callback.apply(this, arguments); });
        }
    });

    // Misc functions used throughout the plugin.
    function AutoComplete (selectors) {
             var completes = [];
             $.each((Array.isArray(selectors)?selectors:[selectors]), function (idx, selector) {
                 var listid = ['AutoComplete', Date.now(), ~~(Math.random()*Date.now()/1000)].join('-'),
                     elm;
                 if ((elm = $(selector).attr('list', listid)).length && !elm.attr('data-autocompleted')) {
                    var datalist = $('<datalist />').attr('id', listid).attr('data-selector', selector);
                    elm.attr('data-autocompleted', 'true');
                    completes.push(datalist);
                    $('body').append(datalist);
                    elm.keyup(_.debounce(function (event) {
                        if (event.keyCode !== 13) {
                           var val = elm.val();
                           if ((!val || 0 === val.length || /^\s*$/.test(val))) {
                              return;
                           }
                           cleanMediaSearch();
                           $MS.__requests.push($.ajax({
                               url: ['https://api.bing.com/osjson.aspx?query=', val, '&JsonType=callback&JsonCallback=?'].join(''),
                               dataType: 'jsonp',
                            }).done(function (data) {
                               datalist.empty();
                               $.map(data[1], function (item) {
                                    datalist.append($('<option value="'+item+'">'));
                               });
                               datalist.append($('<option />'));
                           }));
                       }
                    }, (window['MediaSearch'].autocomplete.speed||500)));
                 }
             });
             return completes;
    }
    function displayResults (provider, html) {
             $('.ms-wrapper .list').append(html.join(''));
             $('.ms-wrapper .list .thumbnail.'+provider).click(function () {
                 area.val(area.val().trim()+' '+$(this).data('link'));
             });
    }
    function cleanMediaSearch () {
             $MS.__requests = $.grep($MS.__requests, function (req) {
                 req.abort();
             });
             if ($MS.__autocompletes) {
                $MS.__autocompletes = $.grep($MS.__autocompletes, function (req) {
                    req.empty();
                    if (!$(req.attr('data-selector')).length) {
                       return !req.remove().length;
                    }
                    return true;
                });
             }
    }
    function onFailure (provider) {
             return function (xhr, msg) {
                 if (!msg || !/^abort$/i.test(msg)) {
                    $('.ms-wrapper .list').prepend('<h6>No results from: '+provider+'</h6>');
                 }
             }
    }
    function bindSearchInputs ($MS) {
             var selectors = ['.ms-wrapper .ms-main','.ms-wrapper .ms-start'];
             if (!$MS.autocomplete.enabled) {
                console.log('Autocomplete is not enabled!');
              } else if (!('options' in document.createElement('datalist'))) {
                console.log('Browser does not support datalist; Can not use Autocomplete!');
              } else {
                $MS.__autocompletes = $MS.__autocompletes.concat(AutoComplete(selectors));
             }
             $('.ms-wrapper .list .ms-start').focus();
             return $(selectors.join(', ')).keyup(function (event) {
                 if (event.keyCode === 13) {
                    $('.ms-wrapper .search').click();
                 }
             });
    }
    function formatter (str, values) {
             return str.replace(/{{(?:\\?:)([^|}]+)(?:\|([^|}]+)?)?}}/g,function(match, key, opt) {
                    return (values[key]?values[key]:(opt?opt:match));
             });
    }
    function getProxyProviders () {
             // Shuffle the CORS proxy list so no one specific provider is spammed.
             return _.shuffle((global['MediaSearch'].corsproxy||{}).proxies);
    }

    // Embed solutions for missing embeds.
    var embeds = [
        // Instagram has https://platform.instagram.com/en_US/embeds.js for managing embeds, this works better if we include it first.
        ['Instagram',/https?:\/\/(www.)?instagr\.?am(\.com)?\/p\/([a-z0-9]+)\/?/i,'https://api.instagram.com/oembed/?omitscript=true&callback=?&url=','rich',function (embed, elm, data) {
            // Process Instagram embeds.
            (function insProccess () {
                if (global.instgrm) {
                   elm.replaceWith($(data.html));
                   global.instgrm.Embeds.process();
                } else { setTimeout(insProcess, 500); }
            })();
        }],
        ['Mixcloud',/https?:\/\/(www\.)?mixcloud\.com\/(.[^\/]+)\/(.+)/i,'https://www.mixcloud.com/oembed/?callback=?&url=','rich'],
        ['Vimeo',/^https?:\/\/vimeo\.com\/(\d+|\w+\/\w+)\/?/i,'https://vimeo.com/api/oembed.json?maxwidth=480&maxheight=270&url=','video'],
        ['Coub',/https?:\/\/(www\.)?coub\.com\/view\/([a-z0-9]+)/i,'https://coub.com/api/oembed.json?maxwidth=480&maxhight=270&url=','video', null, true],
        ['Gfycat',/https?:\/\/(?:www\.)?gfycat\.com\/([a-z]+)/i,'https://api.gfycat.com/v1/oembed?url=','video', function (embed, elm, data, url) {
            // The oembed result from gfycat is annoying to use, create a custom iframe! Make the request to verfy the url.
            elm.replaceWith($('<iframe />').attr('src', ['https://gfycat.com/ifr/', url.match(embed[1])[1]].join('')).css({ width: '480px', height: '270px' }));
        }]
    ];
    if (window['MediaSearch'].apis['giphy'].enabled) {
       var settings = [
           /https?:\/\/(?:.+?)?giphy.com\/(?:.+?\/?)?(?:(?:.*?)\-)?([a-z0-9]+)(?:\/giphy\.gif)?$/i,
           function (embed, url) {
                return formatter('https://api.giphy.com/v1/gifs/{{:id}}?api_key={{:apikey}}',{
                    apikey: window['MediaSearch'].apis['giphy'].apikey,
                    id: url
                });
           }
       ];
       embeds.push(['Giphy', settings[0], settings[1], function (embed, elm, json) {
           if (json.data && json.data.embed_url) {
              elm.replaceWith($('<iframe />').attr('src', json.data.embed_url));
            } else {
              elm.replaceWith($('<i />').html('<h3>Not found.</h3>'));
           }
       }]);
    }
    $.each(embeds, function (index, embed) {
        kiwi.addMediaMessageType(function(url) {
            return embed[1].test(url);
         },function (url) {
            var elm = $('<i class="fa fa-spinner fa-spin fa-3x"></i>'),
                url = (typeof embed[3] === 'function'?url.match(embed[1])[1]:url),
                endpoint = (typeof embed[2] === 'function'?embed[2](embed, url):embed[2]+url),
                tryProxies = (embed[5] && global['MediaSearch'].corsproxy.enabled),
                proxies = getProxyProviders();

            (function makeRequest (pid, embed, proxy, filter) {
                if (tryProxies) {
                   if ((proxy = proxies[pid])) {
                      if (Array.isArray(proxy)) {
                         filter = proxy[1];
                         proxy = proxy[0];
                      }
                      var req = formatter(proxy, { URL: endpoint, URL_ENC: encodeURIComponent(endpoint) });
                    } else {
                      tryProxies = false;
                   }
                }
                $.getJSON((req?req:endpoint)).done(function (data) {
                    if (filter) {
                       data = filter(data);
                    }
                    if (!data || !Object.keys(data).length) {
                       return elm.replaceWith($('<h6>No content from '+embed[0]+'!</h6>'));
                    }
                    if (typeof embed[3] !== 'function') {
                       if (data.type && data.type === embed[3] && data.html) {
                          if (embed[4] && typeof embed[4] === 'function') {
                             embed[4](embed, elm, data, endpoint);
                           } else {
                             elm.replaceWith($(data.html));
                          }
                        } else {
                          elm.replaceWith($('<h6>'+(data.error?data.error:'No embed from '+embed[0]+'!')+'</h6>'));
                       }
                     } else {
                       embed[3](embed, elm, data, url);
                    }
                 }).fail(function () {
                    return (tryProxies?makeRequest(++pid, embed):elm.replaceWith($('<h6>Could not connect to '+embed[0]+'!</h6>')));
                });
            })(0, embed);
            return elm;
        });
    });
})(window, window['MediaSearch']);
</script>
<script type="text/html" id="tmpl_mediasearch">
 <div class="ms-wrapper">
  <span class="header">
   <input class="ms-main" placeholder="Search..." />
   <i class="search menu fa fa-search"></i>
   <i class="undo menu fa fa-undo"></i>
   <i class="settings menu fa fa-cog"></i>
   <i class="close menu fa fa-times"></i><hr class="break" />
  </span>
  <div class="list"></div>
 </div>
</script>
